from app import db
from app.models import Quote, Amount, Label_service
import pandas as pd


def create_df_quote_amount():
    li_df = []
    for quote in Quote.query.all():
        di_df = {
            'quote_id': quote.id,
            'ref_quote': quote.ref_quote,
            'quote_status': quote.quote_status,
            'created_at': quote.created_at,
            'ht_amount': quote.amount.ht_amount if not quote.amount is None else pd.np.nan,
        }
        li_df.append(di_df)

    df = pd.DataFrame(li_df)

    return df


def create_df_quote_company():
    li_df = []
    for quote in Quote.query.all():
        di_df = {
            'quote_id': quote.id,
            'ref_quote': quote.ref_quote,
            'quote_status': quote.quote_status,
            'created_at': quote.created_at,
            'ht_amount': quote.amount.ht_amount if not quote.amount is None else pd.np.nan,
            'company_name': quote.company.company_name,
        }
        li_df.append(di_df)

    df = pd.DataFrame(li_df)

    return df


def create_df_service_amount():
    li = []
    for lab_serv in Label_service.query.all():
        for serv in lab_serv.services:
            li.append({
                "compagnie": [x.company_name for x in serv.companies],
                "ht_amount": [x.amount.ht_amount for x in serv.quotes],
                "ttc_amount": [x.amount.ttc_amount for x in serv.quotes],
                "payment_status": [x.amount.payment_status for x in serv.quotes],
                "paid_at": [x.amount.paid_at for x in serv.quotes],
                "ht_amount": [x.amount.ht_amount for x in serv.quotes],
                "label_services": lab_serv.label,
            })
    df = pd.DataFrame(li)
    for col in df.columns:
        df = df.explode(col)
    df.reset_index(drop=True, inplace=True)

    return df
